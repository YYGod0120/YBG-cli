# 聊一聊单元测试以及在前端中的应用

## 什么是单元测试

**单元测试（unit testing）**，**是指对软件中的最小可测试单元进行检查和验证**。对于单元测试中单元的含义，一般来说，要根据实际情况去判定其具体含义，如 C 语言中单元指一个函数，`Java` 里单元指一个类，图形化的软件中可以指一个窗口或一个菜单等。总的来说，单元就是人为规定的最小的被测功能模块。单元测试是在软件开发过程中要进行的最低级别的测试活动，软件的独立单元将在与程序的其他部分相隔离的情况下进行测试。

### 单元测试的优势

**编写单元测试**，它可以：

- **可以有效地降低程序出错的机率**：在开发阶段就捕获潜在的逻辑错误，避免问题在后期暴露导致更高的修复成本，为代码的现有功能提供了保护网，防止改动引入新问题（即回归问题）。

- **成为最佳文档**：单元测试明确展示了代码预期的输入、输出和行为，这相当于为代码编写了使用手册。其他开发者可以通过测试用例快速理解代码的功能和设计目的，而无需阅读复杂的逻辑。

- **提高代码健壮性**：允许在任何时候代码重构，快速验证代码改动，减少回归问题，提高代码的长期可维护性，而不必担心破坏现有的代码。

### 单元测试的概念

**测试类型**：

- **单元测试**：聚焦于小范围的代码单元（如函数、类），快速验证逻辑的正确性。

- **集成测试**：验证多个模块或单元之间的交互是否正常。

- **端到端测试（E2E）**：测试整个系统的工作流，包括前端、后端和数据库等。

- **回归测试**：验证更新或修改代码后，其他功能是否受到影响。

- **UI 测试**：关注的是用户界面层的行为、布局和交互。

**核心概念**：

1. **覆盖率（Code Coverage）**：覆盖率是衡量测试用例对代码覆盖程度的重要指标，表示被测试的代码中实际被执行的部分占总代码的比例。包括**语句覆盖（Statement Coverage）**，**分支覆盖（Branch Coverage）**，**条件覆盖（Condition Coverage）**，**路径覆盖（Path Coverage）**

2. **存根（Stub）**：存根是一种用来替代代码中某些依赖的轻量模拟对象，通常用于测试被测单元的特定场景，而不依赖实际的外部资源或模块。

3. **模拟（Mock）**：模拟是创建一个替代的函数或对象来模仿实际代码行为。模拟可以记录交互行为、验证调用次数等，是测试外部依赖时的关键工具。

4. **断言（Assertion）**：断言/匹配器是测试的核心，用于验证代码输出是否符合预期。

   **常见断言方法：**

   - **toBe**：验证简单的值相等。

   - **toEqual**：验证对象或数组等复杂数据结构的相等。

   - **toBeTruthy/toBeFalsy**：验证布尔值或值的真/假性。

   - **toThrow**：验证是否抛出了异常。

# 单测在前端的应用

前端代码都运行在浏览器里，抛开 UI,针对`Javascript`来讲，单测通常是针对函数、模块、对象进行测试。前端单测框架如 `QUnit`、`Sinon`、`Mocha` 等，也有如`vue` & `react` 初始化工程自带的`vitest`、`jest`等，单测的执行环境可以是日常使用的浏览器 `ie`、`Chrome` 等，也可以是无界面浏览器比如 `PhantomJS`、`Headless Chrome`

### 前端单测工具链

**测试框架**：测试框架是单元测试的核心，它提供了单元测试所需的各种 API，支持自身（Jest）或者通过集合外部各种测试工具（Mocha）如断言，mock 工具以及覆盖率工具进行定制化配置单元测试。

**测试运行库**：测试管理工具是用来组织和运行整个测试的工具，它能够将测试框架、断言库、测试浏览器、测试代码和被测试代码组织起来，并运行被测试代码进行测试。不过随着测试框架的发展逐渐不需要运行库的组织，如 Karma 等运行库已经废弃。

**断言库**：断言库提供了用于描述你的具体测试的 API，有了它们你的测试代码便能简单直接，也更为语义化。如 `toBe`, `toEqual`, `toContain`等等。

**Mock 工具**：Mock 工具用于隔离测试，模拟外部依赖（如 API 调用、模块）。

**代码覆盖率工具**：代码覆盖率工具用于生成覆盖率报告，分析测试是否全面。

### 单测框架对比

除了前面提到的三大测试框架，业界目前还流行包括`Cypress`和`Vitest`在内的前端测试工具，它们更偏向于前端测试如 UI 测试，E2E 测试以及功能验证。而`Vitest`更像是`Jest`的替代，更适配`Vite`的工具但功能于`Jest`相差不大的单测框架。因此我们更偏向于社区更活跃且更稳定的`Jest`。

### Jest

`Jest`由 Facebook 维护的开源前端单测框架，拥有庞大的社区群体，是目前最流行，热度最高的前端单元测试框架。作为一个 TDD 测试框架，不同于`Mocha`，他自带各种工具包括断言库，Mock 工具以及代码覆盖率检测。开箱即用，上手难度大大低于`Mocha`。

### Mocha

作为另外一款 TDD 测试框架，通过配置断言库，Mock 工具等等单元测试工具链，可以实现高度定制化单测，适合大型，复杂的前端项目。支持浏览器以及 Nodejs 环境测试。

### Jasmine

Jasmine 是一个用于`JavaScript` 的行为驱动开发测试框架。它不依赖于浏览器、`DOM`或任何`JavaScript`框架。因此，它适用于网站、Node.js 项目或 JavaScript 可以运行的任何位置。

| 特性               | Jasmine                                                        | Jest                                           | Mocha                              |
| ------------------ | -------------------------------------------------------------- | ---------------------------------------------- | ---------------------------------- |
| **定位**           | 全功能测试框架，支持断言、Mock、Spy 等功能，适合通用测试场景。 | 全功能测试框架，专为 React、Vue 等前端框架优化 | 轻量级测试框架，灵活性高           |
| **开箱即用**       | 是                                                             | 是                                             | 否                                 |
| **断言库**         | 内置断言库                                                     | 内置断言库                                     | 无内置断言库                       |
| **Mock/Spy 支持**  | 内置支持 Mock 和 Spy。                                         | 内置支持 Mock 和 Spy。                         | 无内置 Mock 和 Spy 功能（需配置）  |
| **快照测试**       | 不支持（需配置）                                               | 支持                                           | 不支持（需配置）                   |
| **异步测试支持**   | 支持 Promise 和 async/await                                    | 支持 Promise 和 async/await                    | 支持回调、Promise 和 async/await。 |
| **代码覆盖率支持** | 不支持（需配置）                                               | 支持                                           | 不支持（需配置）                   |
| **浏览器支持**     | 不支持                                                         | 不支持                                         | 支持                               |
| **风格类型**       | BDD                                                            | TDD                                            | TDD 和 BDD                         |

> TDD（Test-Driven Development）先写测试用例，再编写实现代码。

> BDD（Behavior Driven Development） 以行为描述的方式编写测试，强调软件系统的业务需求。

### 最佳实践